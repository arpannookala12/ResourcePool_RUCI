<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>baselinemodels</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">RUCI LAB</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./datadict.html"> 
<span class="menu-text">Data Dictionary (CDC, EPA, USGS)</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./eda.html"> 
<span class="menu-text">EDA for HPS data</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#cps-binary-classification-model-results-explainability" id="toc-cps-binary-classification-model-results-explainability" class="nav-link active" data-scroll-target="#cps-binary-classification-model-results-explainability">CPS Binary Classification Model Results &amp; Explainability</a></li>
  </ul>
<div class="quarto-alternate-notebooks"><h2>Notebooks</h2><ul><li><a href="hps_cps_pums-preview.html"><i class="bi bi-journal-code"></i>HPS Binary Classification Model</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="cps-binary-classification-model-results-explainability" class="level1">
<h1>CPS Binary Classification Model Results &amp; Explainability</h1>
<p>Multicollinearity Analysis</p>
<div class="quarto-embed-nb-cell">
<div id="vif" class="cell" data-outputid="fbe6fd1a-4c1b-4776-d81c-4b5d70ab0708" data-execution_count="38">
<div class="cell-output cell-output-stdout">
<pre><code>Performing multicollinearity analysis...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>VIF Results:
     Feature        VIF
0   hehousut   1.046027
1   hetelhhd   2.254292
2   hetelavl   2.282600
3   hefaminc   1.434420
4   hrnumhou   2.452866
5    hrhtype   4.732866
6      HUBUS   1.156651
7      gereg   0.000000
8      gediv   0.000000
9   gestfips   2.652757
10    gtcbsa   2.183617
11      gtco   2.202980
12  gtcbsast   4.391335
13  gtmetsta   2.231556
14  gtindvpc   2.651372
15  gtcbsasz   9.794757
16     gtcsa   5.458005
17     perrp   5.387685
18    prtage   1.678536
19  pemaritl   3.464919
20     pesex   1.148676
21   peeduca   1.524835
22  ptdtrace   1.271114
23   prdthsp   5.773714
24  PUCHINHH   1.015834
25  prfamrel   6.719113
26  prfamtyp   4.662360
27  pehspnon   5.659180
28  penatvty   7.903467
29  pemntvty   8.318010
30  pefntvty   7.946751
31  prcitshp  12.204819
32  prinuyer   8.446316
33      PUWK   1.015886
34    pemjot  83.410023
35   pemjnum  83.510317
36  pehruslt   2.022003
37  pehractt   2.050188
38  peio1cow   1.171097
39  prdtind1   1.193875
40  prdtocc1   1.359964
41   pternwa   3.260463
42      ptwk   3.171225
43    prchld   4.825561
44  prnmchld   5.667953
Dropping features with high VIF: ['prcitshp', 'pemjot', 'pemjnum']</code></pre>
</div>
</div>
<a class="quarto-notebook-link" id="nblink-1" href="hps_cps_pums-preview.html#cell-vif">Source: HPS Binary Classification Model</a></div>
<p>Model Peformance</p>
<div class="quarto-embed-nb-cell">
<div id="results" class="cell" data-outputid="2f366896-79ca-4c97-c0db-646b69c07d79" data-execution_count="44">
<div class="cell-output cell-output-stdout">
<pre><code>
Cross-validation results:
Best AUC: 0.8887 (+/- 0.0034)
Best Error: 0.1568 (+/- 0.0013)

Training final model...

Comprehensive Model Performance Metrics:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Accuracy: 0.8443
Precision (Positive Predictive Value): 0.8764
Recall (Sensitivity/True Positive Rate): 0.9254
Specificity (True Negative Rate): 0.5886
False Positive Rate: 0.4114
False Negative Rate: 0.0746
F1 Score: 0.9002
Prevalence: 0.7593
Negative Predictive Value: 0.7143
Positive Likelihood Ratio: 2.2492
Negative Likelihood Ratio: 0.1268

Classification Report:
              precision    recall  f1-score   support

           0       0.71      0.59      0.65       858
           1       0.88      0.93      0.90      2706

    accuracy                           0.84      3564
   macro avg       0.80      0.76      0.77      3564
weighted avg       0.84      0.84      0.84      3564


Confusion Matrix:
[[ 505  353]
 [ 202 2504]]

ROC AUC Score: 0.8916

Top 10 Most Important Features:
     Feature  Importance
26  prdtocc1       234.0
25  prdtind1       223.0
12    prtage       176.0
6       gtco       134.0
15   peeduca       127.0
23  pehractt       126.0
0   hefaminc       111.0
24  peio1cow       108.0
19  pemntvty        91.0
3      HUBUS        77.0
11     perrp        75.0
1   hrnumhou        67.0
22  pehruslt        66.0
21  prinuyer        58.0
20  pefntvty        55.0
17  prfamrel        51.0
5     gtcbsa        47.0
27   pternwa        44.0
28    prchld        43.0
14     pesex        42.0
10     gtcsa        36.0
29  prnmchld        36.0
16  ptdtrace        32.0
18  penatvty        28.0
2    hrhtype        27.0
4   gestfips        26.0
8   gtindvpc        24.0
13  pemaritl        22.0
9   gtcbsasz        14.0
7   gtcbsast        12.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="baselinemodels_files/figure-html/hps_cps_pums-results-output-3.png" id="results-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="baselinemodels_files/figure-html/hps_cps_pums-results-output-4.png" id="results-2" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
<p>Probit Model</p>
<div class="quarto-embed-nb-cell">
<div id="probit" class="cell" data-outputid="d255b489-1e40-41f8-f3d1-5b4b5513c424" data-execution_count="45">
<div class="cell-output cell-output-stdout">
<pre><code>
Fitting Probit model for effect sizes and p-values...
Optimization terminated successfully.
         Current function value: 0.427806
         Iterations 6

Probit Model Summary:
                          Probit Regression Results                           
==============================================================================
Dep. Variable:                 pttlwk   No. Observations:                14255
Model:                         Probit   Df Residuals:                    14224
Method:                           MLE   Df Model:                           30
Date:                Sat, 01 Feb 2025   Pseudo R-squ.:                  0.2249
Time:                        21:12:39   Log-Likelihood:                -6098.4
converged:                       True   LL-Null:                       -7868.1
Covariance Type:            nonrobust   LLR p-value:                     0.000
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
const          2.2208      0.902      2.463      0.014       0.454       3.988
hefaminc      -0.0550      0.006     -9.743      0.000      -0.066      -0.044
hrnumhou       0.0550      0.014      3.858      0.000       0.027       0.083
hrhtype        0.0036      0.014      0.266      0.790      -0.023       0.030
HUBUS          0.2808      0.031      9.035      0.000       0.220       0.342
gestfips       0.1019      0.022      4.544      0.000       0.058       0.146
gtcbsa     -3.337e-06   1.93e-06     -1.729      0.084   -7.12e-06    4.46e-07
gtco        -8.21e-05      0.001     -0.151      0.880      -0.001       0.001
gtcbsast       0.1007      0.032      3.175      0.001       0.039       0.163
gtindvpc       0.0028      0.041      0.069      0.945      -0.077       0.083
gtcbsasz       0.0894      0.020      4.542      0.000       0.051       0.128
gtcsa         -0.0012      0.000     -6.856      0.000      -0.002      -0.001
perrp          0.0007      0.005      0.137      0.891      -0.009       0.011
prtage         0.0054      0.001      4.802      0.000       0.003       0.008
pemaritl       0.0251      0.011      2.260      0.024       0.003       0.047
pesex         -0.1291      0.027     -4.695      0.000      -0.183      -0.075
peeduca       -0.1358      0.007    -19.551      0.000      -0.149      -0.122
ptdtrace      -0.0401      0.011     -3.645      0.000      -0.062      -0.019
prfamrel       0.1337      0.022      5.951      0.000       0.090       0.178
penatvty    7.458e-05      0.000      0.246      0.805      -0.001       0.001
pemntvty       0.0010      0.000      3.370      0.001       0.000       0.002
pefntvty      -0.0003      0.000     -1.054      0.292      -0.001       0.000
prinuyer       0.0044      0.003      1.526      0.127      -0.001       0.010
pehruslt       0.0014      0.001      1.061      0.289      -0.001       0.004
pehractt      -0.0056      0.002     -3.699      0.000      -0.009      -0.003
peio1cow      -0.1141      0.012     -9.191      0.000      -0.138      -0.090
prdtind1       0.0064      0.001      5.538      0.000       0.004       0.009
prdtocc1       0.0539      0.002     24.860      0.000       0.050       0.058
pternwa    -1.354e-07   9.27e-08     -1.461      0.144   -3.17e-07    4.62e-08
prchld         0.0042      0.010      0.407      0.684      -0.016       0.024
prnmchld      -0.0282      0.033     -0.859      0.390      -0.092       0.036
==============================================================================

Marginal Effects (Probit):
       Probit Marginal Effects       
=====================================
Dep. Variable:                 pttlwk
Method:                          dydx
At:                           overall
==============================================================================
                dy/dx    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
hefaminc      -0.0132      0.001     -9.814      0.000      -0.016      -0.011
hrnumhou       0.0133      0.003      3.862      0.000       0.007       0.020
hrhtype        0.0009      0.003      0.266      0.790      -0.006       0.007
HUBUS          0.0676      0.007      9.111      0.000       0.053       0.082
gestfips       0.0245      0.005      4.554      0.000       0.014       0.035
gtcbsa     -8.035e-07   4.65e-07     -1.729      0.084   -1.71e-06    1.07e-07
gtco       -1.977e-05      0.000     -0.151      0.880      -0.000       0.000
gtcbsast       0.0242      0.008      3.179      0.001       0.009       0.039
gtindvpc       0.0007      0.010      0.069      0.945      -0.019       0.020
gtcbsasz       0.0215      0.005      4.552      0.000       0.012       0.031
gtcsa         -0.0003   4.27e-05     -6.884      0.000      -0.000      -0.000
perrp          0.0002      0.001      0.137      0.891      -0.002       0.003
prtage         0.0013      0.000      4.810      0.000       0.001       0.002
pemaritl       0.0060      0.003      2.261      0.024       0.001       0.011
pesex         -0.0311      0.007     -4.706      0.000      -0.044      -0.018
peeduca       -0.0327      0.002    -20.201      0.000      -0.036      -0.030
ptdtrace      -0.0097      0.003     -3.649      0.000      -0.015      -0.004
prfamrel       0.0322      0.005      5.969      0.000       0.022       0.043
penatvty    1.796e-05   7.29e-05      0.246      0.805      -0.000       0.000
pemntvty       0.0002   7.18e-05      3.374      0.001       0.000       0.000
pefntvty   -7.247e-05   6.87e-05     -1.054      0.292      -0.000    6.23e-05
prinuyer       0.0011      0.001      1.527      0.127      -0.000       0.002
pehruslt       0.0003      0.000      1.061      0.289      -0.000       0.001
pehractt      -0.0014      0.000     -3.705      0.000      -0.002      -0.001
peio1cow      -0.0275      0.003     -9.272      0.000      -0.033      -0.022
prdtind1       0.0015      0.000      5.555      0.000       0.001       0.002
prdtocc1       0.0130      0.000     26.497      0.000       0.012       0.014
pternwa    -3.261e-08   2.23e-08     -1.462      0.144   -7.63e-08    1.11e-08
prchld         0.0010      0.002      0.407      0.684      -0.004       0.006
prnmchld      -0.0068      0.008     -0.860      0.390      -0.022       0.009
==============================================================================</code></pre>
</div>
</div>
</div>
<p>SHAP Results</p>
<div class="quarto-embed-nb-cell">
<div id="shap" class="cell" data-outputid="aebcd33f-8625-4f16-b973-7ff6ba630f55">
<div class="cell-output cell-output-stdout">
<pre><code>
Calculating and plotting SHAP values for XGBoost model...
Generating SHAP Beeswarm plot...</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="baselinemodels_files/figure-html/hps_cps_pums-shap-output-2.png" id="shap-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Generating SHAP Bar plot...</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="baselinemodels_files/figure-html/hps_cps_pums-shap-output-4.png" id="shap-2" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>